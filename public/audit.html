<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Consultation Audit System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            padding: 0;
            color: #e0e0e0;
        }

        .nav-header {
            background: #2d2d2d;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            margin-bottom: 2rem;
        }

        .nav-header nav {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .nav-header .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }

        .nav-header .nav-links {
            display: flex;
            gap: 1.5rem;
            margin-left: auto;
        }

        .nav-header a {
            color: #e0e0e0;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-header a:hover {
            color: #667eea;
        }

        .nav-header a.active {
            color: #667eea;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 20px;
        }

        h1 {
            color: #e0e0e0;
            text-align: center;
            margin-bottom: 15px;
            font-size: 2.5em;
        }

        h2, h3, h4 {
            color: #e0e0e0;
        }

        .subtitle {
            color: #a0a0a0;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .back-button {
            display: none;
        }

        .card {
            background: #2d2d2d;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            padding: 30px;
            margin-bottom: 30px;
        }

        .review-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .review-type-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 3px solid transparent;
        }

        .review-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
        }

        .review-type-card.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .review-type-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .review-type-card p {
            opacity: 0.9;
            line-height: 1.5;
        }

        .review-type-card .requirement {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }

        .speed-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-top: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e0e0e0;
        }

        input[type="text"] {
            padding: 12px;
            border: 2px solid #4d4d4d;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: #3d3d3d;
            color: #e0e0e0;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .doctor-initials-input {
            width: 150px;
            text-transform: uppercase;
            font-weight: 600;
            text-align: center;
        }

        .doctor-info-section {
            background: #3d3d3d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .doctor-info-section label {
            color: #667eea;
            font-size: 0.95em;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #4d4d4d;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            transition: border-color 0.3s;
            background: #3d3d3d;
            color: #e0e0e0;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .text-preview {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #4d4d4d;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: #3d3d3d;
            color: #e0e0e0;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
            display: none;
        }

        .text-preview.active {
            display: block;
        }

        .highlighted-issue {
            background-color: #3a1a1a;
            border-bottom: 2px solid #f44336;
            padding: 2px 4px;
            border-radius: 2px;
            cursor: help;
            position: relative;
            color: #ffaaaa;
        }

        .highlighted-issue:hover::after {
            content: attr(data-reason);
            position: absolute;
            bottom: 100%;
            left: 0;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }

        .toggle-view {
            text-align: right;
            margin-bottom: 10px;
        }

        .toggle-view button {
            padding: 8px 16px;
            font-size: 13px;
            width: auto;
            background: #667eea;
        }

        .help-text {
            margin-top: 8px;
            color: #a0a0a0;
            font-size: 0.9em;
            font-style: italic;
        }

        .validation-warning {
            display: none;
            background: #3a3a1a;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
        }

        .validation-warning.active {
            display: block;
        }

        .validation-warning.error {
            background: #3a1a1a;
            border-left-color: #dc3545;
        }

        .validation-warning h4 {
            color: #ffeb3b;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .validation-warning.error h4 {
            color: #ff8a8a;
        }

        .validation-warning ul {
            margin: 10px 0 0 20px;
            color: #ffeb3b;
        }

        .validation-warning.error ul {
            color: #ff8a8a;
        }

        .validation-warning li {
            margin-bottom: 5px;
        }

        button {
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(33, 147, 176, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2193b0;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2em;
            color: #e0e0e0;
            margin-bottom: 10px;
        }

        .loading-detail {
            color: #a0a0a0;
            font-size: 0.9em;
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-stat {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .summary-stat-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .rag-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.2em;
            margin: 10px 0;
        }

        .rag-GREEN {
            background: #4caf50;
            color: white;
        }

        .rag-YELLOW {
            background: #ffeb3b;
            color: #333;
        }

        .rag-AMBER {
            background: #ff9800;
            color: white;
        }

        .rag-RED {
            background: #f44336;
            color: white;
        }

        .consultation-item {
            background: #3d3d3d;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .consultation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #5d5d5d;
        }

        .consultation-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #e0e0e0;
        }

        .consultation-score {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .criterion {
            background: #2d2d2d;
            border-radius: 6px;
            padding: 12px;
            border-left: 4px solid #5d5d5d;
        }

        .criterion.acceptable {
            border-left-color: #4caf50;
        }

        .criterion.concern {
            border-left-color: #ff9800;
        }

        .criterion.unacceptable {
            border-left-color: #f44336;
        }

        .criterion-title {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 5px;
            color: #e0e0e0;
        }

        .criterion-rating {
            font-size: 0.8em;
            text-transform: uppercase;
            font-weight: 600;
        }

        .detailed-analysis {
            margin-top: 30px;
        }

        .analysis-section {
            background: #3d3d3d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analysis-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .concern-list, .strength-list {
            list-style: none;
        }

        .concern-list li, .strength-list li {
            padding: 10px;
            margin-bottom: 8px;
            background: #2d2d2d;
            border-radius: 6px;
            border-left: 4px solid #ff9800;
            color: #e0e0e0;
        }

        .strength-list li {
            border-left-color: #4caf50;
        }

        .recommendation-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 10px;
        }

        .priority-HIGH {
            background: #f44336;
            color: white;
        }

        .priority-POSITIVE {
            background: #4caf50;
            color: white;
        }

        .action-buttons {
            margin-top: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .collapsible-section {
            margin-bottom: 15px;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 15px;
            background: #3d3d3d;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
            color: #e0e0e0;
        }

        .collapsible-header:hover {
            background: #4d4d4d;
        }

        .collapsible-content {
            display: none;
            padding: 20px;
            border: 1px solid #5d5d5d;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background: #2d2d2d;
        }

        .collapsible-content.active {
            display: block;
        }

        .arrow {
            transition: transform 0.3s;
        }

        .arrow.rotated {
            transform: rotate(90deg);
        }

        @media (max-width: 768px) {
            .review-type-selector {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="nav-header">
        <nav>
            <a href="/" class="logo">üè• GP Assessment</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/audit.html" class="active">Audit System</a>
                <a href="/search.html">Search</a>
            </div>
        </nav>
    </div>
    <a href="/" class="back-button">
        <span>‚Üê</span>
        <span>Back to Home</span>
    </a>
    
    <div class="container">
        <h1>üè• Medical Consultation Audit System</h1>
        <p class="subtitle">Comprehensive review of GP consultation notes with AI-powered assessment</p>

        <!-- Input Section -->
        <div class="card" id="inputSection">
            <h2 style="margin-bottom: 10px; color: #e0e0e0;">Conduct Audit</h2>
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 25px; text-align: center;">
                <strong>üìã Quick Guide:</strong> 
                <span style="opacity: 0.95;">1Ô∏è‚É£ Enter Reference Number ‚Üí 2Ô∏è‚É£ Enter Doctor Initials ‚Üí 3Ô∏è‚É£ Select Review Type ‚Üí 4Ô∏è‚É£ Paste Consultation Notes ‚Üí ‚úÖ Start Audit</span>
            </div>

            <div class="doctor-info-section">
                <label for="referenceNumber">Audit Reference Number: <span style="color: #f44336;">*</span></label>
                <input 
                    type="text" 
                    id="referenceNumber" 
                    class="doctor-initials-input"
                    placeholder="e.g., AUD-2026-001"
                    maxlength="20"
                    style="width: 250px;"
                    required>
                <div class="help-text">Enter a unique reference number for this audit (required)</div>
            </div>

            <div class="doctor-info-section">
                <label for="doctorInitials">Doctor Being Audited (Initials): <span style="color: #f44336;">*</span></label>
                <input 
                    type="text" 
                    id="doctorInitials" 
                    class="doctor-initials-input"
                    placeholder="e.g., GIB"
                    maxlength="10"
                    required>
                <div class="help-text">Enter the initials of the doctor whose consultation notes are being audited (required)</div>
            </div>
            
            <div class="form-group">
                <label style="font-size: 1.2em; font-weight: bold; display: block; margin-bottom: 15px;">
                    <span style="background: #667eea; color: white; padding: 5px 12px; border-radius: 50%; margin-right: 10px;">3</span>
                    STEP 3: Select Review Type
                </label>
            </div>
            <div class="review-type-selector">
                <div class="review-type-card" data-type="rapid" onclick="selectReviewType('rapid')">
                    <h3>üìã Rapid Review</h3>
                    <p>Quick assessment for quality assurance and spot checks</p>
                    <div class="requirement">Requires: Exactly 2 consultations</div>
                    <div class="speed-badge">‚ö° ~30 seconds (parallel processing)</div>
                </div>
                
                <div class="review-type-card" data-type="full" onclick="selectReviewType('full')">
                    <h3>üìä Full Review</h3>
                    <p>Comprehensive audit with detailed analytics and reporting</p>
                    <div class="requirement">Requires: Minimum 10 consultations</div>
                    <div class="speed-badge">‚ö° ~1-2 minutes for 10 notes (5x faster!)</div>
                </div>
            </div>

            <div class="form-group">
                <label for="consultationData" style="font-size: 1.2em; font-weight: bold;">
                    <span style="background: #667eea; color: white; padding: 5px 12px; border-radius: 50%; margin-right: 10px;">4</span>
                    STEP 4: Paste Consultation Notes
                </label>
                <div class="toggle-view">
                    <button type="button" onclick="toggleHighlightView()" id="toggleViewBtn">üîç Show Highlighted Issues</button>
                </div>
                <textarea 
                    id="consultationData" 
                    placeholder="Paste consultation notes in the format:&#10;&#10;Date		Consultation Text&#10;17-Dec-2024 14:15		Face to face consultation...&#10;&#10;Date		Consultation Text&#10;17-Dec-2024 14:33		Face to face consultation..."></textarea>
                <div class="text-preview" id="textPreview"></div>
                <div class="help-text">
                    Final step: Paste your consultation notes with the Date and Consultation Text format. Each consultation should start with a date/time stamp.
                </div>
                <div class="validation-warning" id="validationWarning">
                    <h4>‚ö†Ô∏è Potential Patient Identifiable Information Detected</h4>
                    <p>Please remove the following before proceeding:</p>
                    <ul id="validationIssues"></ul>
                    <p style="margin-top: 10px; font-size: 0.9em;"><strong>Click "Show Highlighted Issues" above to see exactly what was detected.</strong></p>
                </div>
            </div>

            <button onclick="startAudit()" id="startBtn" disabled>
                Start Audit
            </button>
        </div>

        <!-- Loading Section -->
        <div class="card loading" id="loadingSection">
            <div class="spinner"></div>
            <div class="loading-text">Conducting Audit...</div>
            <div class="loading-detail" id="loadingDetail">Initializing assessment...</div>
        </div>

        <!-- Results Section -->
        <div class="results" id="resultsSection">
            <!-- Summary will be inserted here -->
        </div>
    </div>

    <script>
        let selectedReviewType = null;
        let hasValidationIssues = false;
        let currentIssues = [];
        let showingHighlights = false;

        function selectReviewType(type) {
            console.log('selectReviewType called with:', type);
            selectedReviewType = type;
            console.log('selectedReviewType set to:', selectedReviewType);
            
            // Update UI
            document.querySelectorAll('.review-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            const targetCard = document.querySelector(`[data-type="${type}"]`);
            console.log('Target card found:', targetCard);
            if (targetCard) {
                targetCard.classList.add('selected');
            }
            
            // Enable start button if there's text
            updateStartButton();
        }

        function toggleHighlightView() {
            try {
                showingHighlights = !showingHighlights;
                const textarea = document.getElementById('consultationData');
                const preview = document.getElementById('textPreview');
                const btn = document.getElementById('toggleViewBtn');
                
                // Run validation first if we're showing highlights and haven't validated yet
                if (showingHighlights && currentIssues.length === 0) {
                    const text = textarea.value.trim();
                    if (text.length > 0) {
                        const issues = validateConsultationData(text);
                        displayValidationIssues(issues);
                    }
                }
                
                console.log('Toggle highlight view:', showingHighlights);
                console.log('Current issues:', currentIssues);
                
                if (showingHighlights) {
                    textarea.style.display = 'none';
                    preview.classList.add('active');
                    btn.textContent = '‚úèÔ∏è Edit Text';
                    updateHighlightedText();
                } else {
                    textarea.style.display = 'block';
                    preview.classList.remove('active');
                    btn.textContent = 'üîç Show Highlighted Issues';
                }
            } catch (error) {
                console.error('Toggle view error:', error);
            }
        }

        function updateHighlightedText() {
            const text = document.getElementById('consultationData').value;
            const preview = document.getElementById('textPreview');
            
            if (currentIssues.length === 0) {
                preview.innerHTML = text;
                return;
            }
            
            let highlightedText = text;
            const matches = [];
            
            // Collect all matches with their positions
            currentIssues.forEach(issue => {
                let pattern;
                let reason = issue.type;
                
                switch(issue.type) {
                    case 'NHS Number':
                        pattern = /\b\d{3}[\s-]?\d{3}[\s-]?\d{4}\b/g;
                        break;
                    case 'Patient Name':
                        const namePatterns = [
                            /\bPatient[:\s]+([A-Z][a-z]+\s+[A-Z][a-z]+)/gi,
                            /\bName[:\s]+([A-Z][a-z]+\s+[A-Z][a-z]+)/gi,
                            /\bMr\.?\s+[A-Z][a-z]+(?!\s*\(Dr)/gi,
                            /\bMrs\.?\s+[A-Z][a-z]+(?!\s*\(Dr)/gi,
                            /\bMiss\.?\s+[A-Z][a-z]+(?!\s*\(Dr)/gi,
                            /\bMs\.?\s+[A-Z][a-z]+(?!\s*\(Dr)/gi,
                        ];
                        namePatterns.forEach(p => {
                            let match;
                            while ((match = p.exec(text)) !== null) {
                                matches.push({ start: match.index, end: match.index + match[0].length, text: match[0], reason });
                            }
                        });
                        return;
                    case 'Date of Birth':
                        pattern = /\b(DOB|Date of Birth|Born)[:\s]+\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/gi;
                        break;
                    case 'Postcode':
                        pattern = /\b[A-Z]{1,2}\d{1,2}[A-Z]?\s+\d[A-Z]{2}\b/g;
                        break;
                    case 'Phone Number':
                        pattern = /\b0\d{2,4}[\s-]?\d{3,4}[\s-]?\d{4}\b/g;
                        break;
                    case 'Email Address':
                        pattern = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
                        break;
                }
                
                if (pattern) {
                    let match;
                    while ((match = pattern.exec(text)) !== null) {
                        matches.push({ start: match.index, end: match.index + match[0].length, text: match[0], reason });
                    }
                }
            });
            
            // Sort matches by position (reverse order for replacement)
            matches.sort((a, b) => b.start - a.start);
            
            // Replace matches with highlighted versions
            matches.forEach(match => {
                const before = highlightedText.substring(0, match.start);
                const after = highlightedText.substring(match.end);
                highlightedText = before + 
                    `<span class="highlighted-issue" data-reason="${match.reason}">${match.text}</span>` + 
                    after;
            });
            
            preview.innerHTML = highlightedText;
        }

        /**
         * Validate consultation data for patient identifiable information
         */
        function validateConsultationData(text) {
            const issues = [];
            
            // Check for NHS numbers (10 digits, may have spaces)
            const nhsNumberPattern = /\b\d{3}[\s-]?\d{3}[\s-]?\d{4}\b/g;
            const nhsMatches = text.match(nhsNumberPattern);
            if (nhsMatches) {
                issues.push({
                    type: 'NHS Number',
                    count: nhsMatches.length,
                    message: `${nhsMatches.length} potential NHS number(s) found (10-digit numbers)`
                });
            }

            // Check for patient name patterns (but exclude doctor names)
            const namePatterns = [
                /\bPatient[:\s]+([A-Z][a-z]+\s+[A-Z][a-z]+)/gi,
                /\bName[:\s]+([A-Z][a-z]+\s+[A-Z][a-z]+)/gi,
                /\bMr\.?\s+[A-Z][a-z]+(?!\s*\(Dr)/gi,
                /\bMrs\.?\s+[A-Z][a-z]+(?!\s*\(Dr)/gi,
                /\bMiss\.?\s+[A-Z][a-z]+(?!\s*\(Dr)/gi,
                /\bMs\.?\s+[A-Z][a-z]+(?!\s*\(Dr)/gi,
            ];
            
            let nameMatches = [];
            namePatterns.forEach(pattern => {
                const matches = text.match(pattern);
                if (matches) {
                    // Filter out doctor names (those followed by "(Dr)" or "Dr)")
                    const filtered = matches.filter(match => {
                        const index = text.indexOf(match);
                        const afterMatch = text.substring(index + match.length, index + match.length + 10);
                        return !afterMatch.includes('(Dr)') && !afterMatch.includes('Dr)');
                    });
                    nameMatches = nameMatches.concat(filtered);
                }
            });
            
            if (nameMatches.length > 0) {
                issues.push({
                    type: 'Patient Name',
                    count: nameMatches.length,
                    message: `${nameMatches.length} potential patient name(s) found`
                });
            }

            // Check for date of birth patterns
            const dobPatterns = [
                /\bDOB[:\s]+\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/gi,
                /\bDate of Birth[:\s]+\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/gi,
                /\bBorn[:\s]+\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/gi,
            ];
            
            let dobMatches = [];
            dobPatterns.forEach(pattern => {
                const matches = text.match(pattern);
                if (matches) {
                    dobMatches = dobMatches.concat(matches);
                }
            });
            
            if (dobMatches.length > 0) {
                issues.push({
                    type: 'Date of Birth',
                    count: dobMatches.length,
                    message: `${dobMatches.length} date of birth reference(s) found`
                });
            }

            // Check for UK postcodes (improved to reduce false positives)
            // Exclude common medical abbreviations like B12, E45, etc.
            const postcodePattern = /\b[A-Z]{1,2}\d{1,2}[A-Z]?\s+\d[A-Z]{2}\b/g;
            const postcodeMatches = text.match(postcodePattern);
            // Filter out obvious false positives (vitamins, tests, etc.)
            const filteredPostcodes = postcodeMatches ? postcodeMatches.filter(match => {
                // Exclude single letter + number patterns (B12, D3, E45, etc.)
                return !/^[A-Z]\d+$/.test(match.replace(/\s+/g, ''));
            }) : [];
            
            if (filteredPostcodes && filteredPostcodes.length > 0) {
                issues.push({
                    type: 'Postcode',
                    count: filteredPostcodes.length,
                    message: `${filteredPostcodes.length} potential postcode(s) found`
                });
            }

            // Check for phone numbers
            const phonePattern = /\b0\d{2,4}[\s-]?\d{3,4}[\s-]?\d{4}\b/g;
            const phoneMatches = text.match(phonePattern);
            if (phoneMatches) {
                issues.push({
                    type: 'Phone Number',
                    count: phoneMatches.length,
                    message: `${phoneMatches.length} potential phone number(s) found`
                });
            }

            // Check for email addresses
            const emailPattern = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
            const emailMatches = text.match(emailPattern);
            if (emailMatches) {
                issues.push({
                    type: 'Email Address',
                    count: emailMatches.length,
                    message: `${emailMatches.length} email address(es) found`
                });
            }

            return issues;
        }

        function displayValidationIssues(issues) {
            const warningDiv = document.getElementById('validationWarning');
            const issuesList = document.getElementById('validationIssues');
            
            // Store current issues for highlighting
            currentIssues = issues;
            
            // Update highlighted view if it's showing
            if (showingHighlights) {
                updateHighlightedText();
            }
            
            // Only block on high-severity issues (NHS numbers, names, DOB)
            const highSeverityIssues = issues.filter(issue => 
                issue.type === 'NHS Number' || 
                issue.type === 'Patient Name' || 
                issue.type === 'Date of Birth'
            );
            
            if (issues.length === 0) {
                warningDiv.classList.remove('active');
                warningDiv.classList.remove('error');
                hasValidationIssues = false;
            } else if (highSeverityIssues.length > 0) {
                // High severity - block submission
                warningDiv.classList.add('active');
                warningDiv.classList.add('error');
                hasValidationIssues = true;
                warningDiv.querySelector('h4').textContent = 'üö´ Critical: Patient Identifiable Information Detected';
                
                issuesList.innerHTML = issues.map(issue => 
                    `<li><strong>${issue.type}:</strong> ${issue.message}</li>`
                ).join('');
            } else {
                // Only medium severity - warn but don't block
                warningDiv.classList.add('active');
                warningDiv.classList.remove('error');
                hasValidationIssues = false; // Don't block submission
                warningDiv.querySelector('h4').textContent = '‚ö†Ô∏è Potential Information Detected (Review Recommended)';
                
                issuesList.innerHTML = issues.map(issue => 
                    `<li><strong>${issue.type}:</strong> ${issue.message}</li>`
                ).join('');
            }
            
            updateStartButton();
        }

        function updateStartButton() {
            const hasData = document.getElementById('consultationData').value.trim().length > 0;
            const hasType = selectedReviewType !== null;
            const hasInitials = document.getElementById('doctorInitials').value.trim().length > 0;
            const isValid = !hasValidationIssues;
            
            console.log('Button state check:', {
                hasData,
                hasType,
                hasInitials,
                isValid,
                hasValidationIssues,
                shouldEnable: hasData && hasType && hasInitials && isValid
            });
            
            document.getElementById('startBtn').disabled = !(hasData && hasType && hasInitials && isValid);
        }

        // Real-time validation as user types (with debounce)
        let validationTimeout;
        document.getElementById('consultationData').addEventListener('input', function() {
            clearTimeout(validationTimeout);
            
            validationTimeout = setTimeout(() => {
                const text = this.value.trim();
                if (text.length > 0) {
                    const issues = validateConsultationData(text);
                    displayValidationIssues(issues);
                } else {
                    displayValidationIssues([]);
                }
                updateStartButton(); // Update button AFTER validation completes
            }, 500); // Wait 500ms after user stops typing
        });

        document.getElementById('doctorInitials').addEventListener('input', updateStartButton);
        
        // Auto-uppercase doctor initials
        document.getElementById('doctorInitials').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        async function startAudit() {
            const consultationData = document.getElementById('consultationData').value.trim();
            const doctorInitials = document.getElementById('doctorInitials').value.trim();
            const referenceNumber = document.getElementById('referenceNumber').value.trim();
            
            if (!consultationData || !selectedReviewType) {
                alert('Please select an audit type and enter consultation data');
                return;
            }

            if (!referenceNumber) {
                alert('Please enter an audit reference number');
                return;
            }

            if (!doctorInitials) {
                alert('Please enter the doctor\'s initials');
                return;
            }

            // Final validation check - only warn about high severity issues
            const issues = validateConsultationData(consultationData);
            const highSeverityIssues = issues.filter(issue => 
                issue.type === 'NHS Number' || 
                issue.type === 'Patient Name' || 
                issue.type === 'Date of Birth'
            );
            
            if (highSeverityIssues.length > 0) {
                alert(
                    'üö´ SUBMISSION BLOCKED\n\n' +
                    'Critical patient identifiable information detected:\n\n' +
                    highSeverityIssues.map(i => `‚Ä¢ ${i.message}`).join('\n') + '\n\n' +
                    'This violates data protection regulations (GDPR/Data Protection Act 2018).\n\n' +
                    'You must remove NHS numbers, patient names, and dates of birth before proceeding.'
                );
                return;
            }
            
            // Show warning for medium severity but allow to proceed
            if (issues.length > 0) {
                const proceed = confirm(
                    '‚ö†Ô∏è Information Detected\n\n' +
                    issues.map(i => `‚Ä¢ ${i.message}`).join('\n') + '\n\n' +
                    'Please verify this data does not identify patients.\n\n' +
                    'Click OK to proceed if you have verified the data is anonymized.'
                );
                
                if (!proceed) {
                    return;
                }
            }

            // Show loading
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('loadingSection').classList.add('active');

            try {
                const endpoint = selectedReviewType === 'rapid' 
                    ? '/api/audit/rapid-review' 
                    : '/api/audit/full-review';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        consultationData,
                        doctorInitials,
                        referenceNumber
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    
                    // Handle PII validation errors from server
                    if (error.piiIssues) {
                        alert(
                            '‚ùå SERVER VALIDATION FAILED\n\n' +
                            'Patient identifiable information detected by server validation:\n\n' +
                            error.piiIssues.map(i => `‚Ä¢ ${i.message}`).join('\n') + '\n\n' +
                            'Please remove all patient identifiable information and try again.\n\n' +
                            'This is a data protection requirement.'
                        );
                        document.getElementById('inputSection').style.display = 'block';
                        document.getElementById('loadingSection').classList.remove('active');
                        return;
                    }
                    
                    throw new Error(error.error || 'Audit failed');
                }

                const results = await response.json();
                displayResults(results);

            } catch (error) {
                alert('Error conducting audit: ' + error.message);
                console.error('Audit error:', error);
                document.getElementById('inputSection').style.display = 'block';
                document.getElementById('loadingSection').classList.remove('active');
            }
        }

        function displayResults(results) {
            document.getElementById('loadingSection').classList.remove('active');
            document.getElementById('resultsSection').classList.add('active');

            const container = document.getElementById('resultsSection');
            const isFullReview = results.reviewType === 'Full Review';

            let html = `
                <div cla${results.doctorInitials ? `<p style="text-align: center; margin-top: 10px; font-size: 1.1em; opacity: 0.9;">Doctor: <strong>${results.doctorInitials}</strong></p>` : ''}
                        ss="card">
                    <div class="summary-card">
                        <h2>${results.reviewType} Results</h2>
                        <div class="summary-grid">
                            <div class="summary-stat">
                                <div class="summary-stat-value">${results.totalConsultations}</div>
                                <div class="summary-stat-label">Consultations Reviewed</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-stat-value">${results.summary.averageScore}%</div>
                                <div class="summary-stat-label">Average Score</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-stat-value">
                                    <span class="rag-badge rag-${results.summary.overallRAG}">${results.summary.overallRAG}</span>
                                </div>
                                <div class="summary-stat-label">Overall RAG Rating</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-stat-value">${results.processingTime}s</div>
                                <div class="summary-stat-label">Processing Time</div>
                            </div>
                        </div>
                    </div>

                    <h3 style="margin: 30px 0 20px 0; color: #333;">RAG Distribution</h3>
                    <div class="summary-grid">
                        <div class="summary-stat" style="background: #4caf50; color: white; border-radius: 8px;">
                            <div class="summary-stat-value">${results.summary.ragDistribution.GREEN}</div>
                            <div class="summary-stat-label">GREEN</div>
                        </div>
                        <div class="summary-stat" style="background: #ffeb3b; color: #333; border-radius: 8px;">
                            <div class="summary-stat-value">${results.summary.ragDistribution.YELLOW}</div>
                            <div class="summary-stat-label">YELLOW</div>
                        </div>
                        <div class="summary-stat" style="background: #ff9800; color: white; border-radius: 8px;">
                            <div class="summary-stat-value">${results.summary.ragDistribution.AMBER}</div>
                            <div class="summary-stat-label">AMBER</div>
                        </div>
                        <div class="summary-stat" style="background: #f44336; color: white; border-radius: 8px;">
                            <div class="summary-stat-value">${results.summary.ragDistribution.RED}</div>
                            <div class="summary-stat-label">RED</div>
                        </div>
                    </div>
            `;

            // Add detailed analysis for full reviews
            if (isFullReview && results.detailedAnalysis) {
                html += generateDetailedAnalysisHTML(results.detailedAnalysis);
            }

            html += `
                    <h3 style="margin: 30px 0 20px 0; color: #333;">Individual Consultation Assessments</h3>
            `;

            // Add individual consultations
            results.individualAssessments.forEach(consultation => {
                html += generateConsultationHTML(consultation);
            });

            html += `
                    <div class="action-buttons">
                        <button onclick="downloadReport()" class="btn-secondary">üì• Download Report</button>
                        <button onclick="startNewAudit()">üîÑ New Audit</button>
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // Store results for download
            window.currentResults = results;
        }

        function generateDetailedAnalysisHTML(analysis) {
            let html = `
                <div class="detailed-analysis">
                    <h3 style="margin: 30px 0 20px 0; color: #333;">Detailed Analysis</h3>
                    
                    <div class="analysis-section">
                        <h3>üìà Performance Overview</h3>
                        <p><strong>Best Performing Consultation:</strong> Consultation ${analysis.bestPerforming.consultationNumber} (${analysis.bestPerforming.date}) - ${analysis.bestPerforming.score}% <span class="rag-badge rag-${analysis.bestPerforming.rag}">${analysis.bestPerforming.rag}</span></p>
                        <p><strong>Needs Improvement:</strong> Consultation ${analysis.worstPerforming.consultationNumber} (${analysis.worstPerforming.date}) - ${analysis.worstPerforming.score}% <span class="rag-badge rag-${analysis.worstPerforming.rag}">${analysis.worstPerforming.rag}</span></p>
                    </div>

                    <div class="analysis-section">
                        <h3>‚ö†Ô∏è Common Areas of Concern</h3>
                        <ul class="concern-list">
            `;

            analysis.concernAreas.forEach(concern => {
                html += `
                    <li>
                        <strong>${concern.criterionTitle}</strong><br>
                        <small>Occurred in ${concern.count} consultation(s)</small>
                    </li>
                `;
            });

            html += `
                        </ul>
                    </div>

                    <div class="analysis-section">
                        <h3>‚úÖ Strengths</h3>
                        <ul class="strength-list">
            `;

            analysis.strengths.forEach(strength => {
                html += `
                    <li>
                        <strong>${strength.criterionTitle}</strong><br>
                        <small>Consistently acceptable in ${strength.count} consultation(s)</small>
                    </li>
                `;
            });

            html += `
                        </ul>
                    </div>

                    <div class="analysis-section">
                        <h3>üí° Recommendations</h3>
            `;

            analysis.recommendations.forEach(rec => {
                html += `
                    <div style="margin-bottom: 15px;">
                        <span class="recommendation-badge priority-${rec.priority}">${rec.priority}</span>
                        <strong>${rec.area}</strong>
                        <ul style="margin-top: 10px; margin-left: 40px;">
                            ${rec.details.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        function generateConsultationHTML(consultation) {
            const assessment = consultation.assessment;
            
            let html = `
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div>
                            <span class="consultation-title">Consultation ${consultation.consultationNumber}</span>
                            <span style="margin-left: 15px; color: #666; font-size: 0.9em;">${consultation.consultationDate}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <span class="consultation-score">${assessment.scoring.percentage}%</span>
                            <span class="rag-badge rag-${assessment.scoring.ragRating.rating}">${assessment.scoring.ragRating.rating}</span>
                            <span class="arrow">‚ñ∂</span>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div style="margin-bottom: 20px;">
                            <strong>Overall Summary:</strong>
                            <p style="margin-top: 10px; line-height: 1.6;">${assessment.overallSummary}</p>
                        </div>

                        <div style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <strong>Score Breakdown:</strong>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px;">
                                <div>‚úÖ Acceptable: ${assessment.scoring.acceptable}</div>
                                <div>‚ö†Ô∏è Concern: ${assessment.scoring.concern}</div>
                                <div>‚ùå Unacceptable: ${assessment.scoring.unacceptable}</div>
                            </div>
                        </div>

                        <strong>Assessment Criteria:</strong>
                        <div class="criteria-grid">
            `;

            assessment.criteriaAssessments.forEach(criteria => {
                html += `
                    <div class="criterion ${criteria.rating}">
                        <div class="criterion-title">${criteria.criterionTitle}</div>
                        <div class="criterion-rating ${criteria.rating}">${criteria.rating}</div>
                        <p style="font-size: 0.85em; margin-top: 8px; color: #666;">${criteria.explanation}</p>
                    </div>
                `;
            });

            html += `
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <strong>Recommendations:</strong>
                            <ul style="margin-top: 10px; margin-left: 20px;">
                                ${assessment.recommendations.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        function toggleCollapsible(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.arrow');
            
            content.classList.toggle('active');
            arrow.classList.toggle('rotated');
        }

        function downloadReport() {
            const results = window.currentResults;
            if (!results) return;

            const reportText = generateTextReport(results);
            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit-report-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateTextReport(results) {
            let report = `MEDICAL CONSULTATION AUDIT REPORT\n`;
            report += `${'='.repeat(60)}\n\n`;
            if (results.doctorInitials) {
                report += `Doctor: ${results.doctorInitials}\n`;
            }
            report += `Review Type: ${results.reviewType}\n`;
            report += `Date: ${new Date(results.completedAt).toLocaleString()}\n`;
            report += `Total Consultations: ${results.totalConsultations}\n`;
            report += `Processing Time: ${results.processingTime}s\n\n`;

            report += `OVERALL SUMMARY\n`;
            report += `${'-'.repeat(60)}\n`;
            report += `Average Score: ${results.summary.averageScore}%\n`;
            report += `Overall RAG Rating: ${results.summary.overallRAG}\n`;
            report += `Highest Score: ${results.summary.highestScore}%\n`;
            report += `Lowest Score: ${results.summary.lowestScore}%\n\n`;

            report += `RAG DISTRIBUTION\n`;
            report += `${'-'.repeat(60)}\n`;
            report += `GREEN: ${results.summary.ragDistribution.GREEN}\n`;
            report += `YELLOW: ${results.summary.ragDistribution.YELLOW}\n`;
            report += `AMBER: ${results.summary.ragDistribution.AMBER}\n`;
            report += `RED: ${results.summary.ragDistribution.RED}\n\n`;

            if (results.detailedAnalysis) {
                report += `DETAILED ANALYSIS\n`;
                report += `${'-'.repeat(60)}\n\n`;
                
                const da = results.detailedAnalysis;
                report += `Best Performing: Consultation ${da.bestPerforming.consultationNumber} - ${da.bestPerforming.score}% (${da.bestPerforming.rag})\n`;
                report += `Needs Improvement: Consultation ${da.worstPerforming.consultationNumber} - ${da.worstPerforming.score}% (${da.worstPerforming.rag})\n\n`;

                if (da.concernAreas.length > 0) {
                    report += `Common Areas of Concern:\n`;
                    da.concernAreas.forEach(c => {
                        report += `  - ${c.criterionTitle} (${c.count} occurrences)\n`;
                    });
                    report += `\n`;
                }

                if (da.strengths.length > 0) {
                    report += `Strengths:\n`;
                    da.strengths.forEach(s => {
                        report += `  - ${s.criterionTitle} (${s.count} times)\n`;
                    });
                    report += `\n`;
                }
            }

            report += `INDIVIDUAL CONSULTATIONS\n`;
            report += `${'='.repeat(60)}\n\n`;

            results.individualAssessments.forEach(consultation => {
                const assessment = consultation.assessment;
                report += `Consultation ${consultation.consultationNumber} - ${consultation.consultationDate}\n`;
                report += `${'-'.repeat(60)}\n`;
                report += `Score: ${assessment.scoring.percentage}% (${assessment.scoring.ragRating.rating})\n`;
                report += `Acceptable: ${assessment.scoring.acceptable}, Concern: ${assessment.scoring.concern}, Unacceptable: ${assessment.scoring.unacceptable}\n\n`;
                report += `Summary:\n${assessment.overallSummary}\n\n`;
                report += `\n`;
            });

            return report;
        }

        function startNewAudit() {
            document.getElementById('resultsSection').classList.remove('active');
            document.getElementById('doctorInitials').value = '';
            document.getElementById('resultsSection').innerHTML = '';
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('consultationData').value = '';
            selectedReviewType = null;
            document.querySelectorAll('.review-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            updateStartButton();
        }
    </script>
</body>
</html>
